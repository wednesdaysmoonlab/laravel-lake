#!/usr/bin/env bash
set -euo pipefail

LAKEUP="$(dirname "$0")/lakeup"

CURRENT=$(grep 'LAKE_SETUP_VERSION=' "$LAKEUP" | head -1 | sed 's/.*"\(.*\)".*/\1/')

printf 'Enter release version (current %s): ' "$CURRENT"
read -r VERSION

VERSION="${VERSION#v}"  # strip leading 'v' if user typed it

if [[ -z "$VERSION" ]]; then
  echo "Aborted: no version entered."
  exit 1
fi

if [[ "$VERSION" == "$CURRENT" ]]; then
  echo "Aborted: version is unchanged ($CURRENT)."
  exit 1
fi

if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
  echo "Aborted: \"$VERSION\" is not a valid semver (X.Y.Z)."
  exit 1
fi

# Bump version in lakeup
if [[ "$(uname -s)" == "Darwin" ]]; then
  sed -i '' "s/LAKE_SETUP_VERSION=\"${CURRENT}\"/LAKE_SETUP_VERSION=\"${VERSION}\"/" "$LAKEUP"
else
  sed -i "s/LAKE_SETUP_VERSION=\"${CURRENT}\"/LAKE_SETUP_VERSION=\"${VERSION}\"/" "$LAKEUP"
fi

echo "Bumped LAKE_SETUP_VERSION: $CURRENT → $VERSION"

git add "$LAKEUP"
git commit -m "release v${VERSION}"
git tag "v${VERSION}"
git push origin main
git push origin "v${VERSION}"

echo "Released v${VERSION} — GitHub Actions will publish the release."
